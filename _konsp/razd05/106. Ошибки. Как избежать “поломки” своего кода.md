# 106. Ошибки. Как избежать “поломки” своего кода

## `try...catch`

Конструкция `try...catch` пытается выполнить инструкции в блоке `try`, и, в случае ошибки, выполняет блок `catch`.

Конструкция `try` содержит блок `try`, в котором находится одна или несколько инструкций (Блок (`{}` ) обязательно должен присутствовать, даже если выполняется всего одна инструкция), и хотя бы один блок catch или `finally`. Таким образом, есть три основные формы конструкции `try`:

```javascript
    try {...} catch {...}
    try {...} finally {...}
    try {...} catch {...} finally {...}
```
Блок catch содержит инструкции, которые будут выполнены, если в блоке `try` произошла ошибка. Если любая инструкция в блоке `try` выбрасывает исключение, то управление сразу же переходит в блок `catch`. Если в блок `try` не было выброшено исключение, то блок `catch` не выполняется.

Блок finally выполнится после выполнения блоков `try` и catch, но перед инструкциями, следующими за конструкцией `try`...catch. Он выполняется всегда, в независимости от того, было исключение или нет.

Вы можете использовать вложенные конструкции `try`. Если внутренняя конструкция `try` не имеет блока catch (такое может быть при её использовании в виде `try {...} finaly {...}`, потому что `try {...}` не может быть без блоков `catch` или `finally`), будет вызван сatch внешней конструкции `try`.

Конструкция `try` также используется для обработки исключений JavaScript (то есть, выброшенных внутренними функциями языка или парсером). Загляните в JavaScript руководство для дополнительной информации о JavaScript исключениях.
Безусловный блок `catch`

При использовании блока `catch`, он вызывается для любого исключения в блоке try. Например, когда в следующем коде происходит ошибка, управление переходит к блоку `catch`.

```javascript
try {
   throw 'myException'; // создание исключения
}
catch (e) {
   // инструкции для обработки ошибок
   logMyErrors(e); // передать объект исключения обработчику ошибок
}
```
Блок `catch` задаёт идентификатор (`e` в примере выше) который содержит объект исключения (в примере выше — значение, переданное оператору `throw`). Область видимости этого объекта ограничивается блоком `catch`.

## Условный блок `catch`

"Условные блоки `catch`" можно создавать, используя `try...catch` с `if...else if...else`, как здесь:

```javascript
try {
  myroutine(); // может выбрасывать три вида исключений
} catch (e) {
  if (e instanceof TypeError) {
    // обработка исключения TypeError
  } else if (e instanceof RangeError) {
    // обработка исключения RangeError
  } else if (e instanceof EvalError) {
    // обработка исключения EvalError
  } else {
    // обработка остальных исключений
    logMyErrors(e); // передать обработчику ошибок
  }
}
```
Частый сценарий использования — обработать известные исключения, а при неизвестных ошибках, пробросить их дальше:

```javascript
try {
  myRoutine();
} catch(e) {
  if (e instanceof RangeError) {
    // обработка известного исключения, с которым
    // понятно, что делать
  } else {
    throw e; // пробросить неизвестные ошибки
  }
}
```

## Идентификатор исключения

Когда в блоке try выбрасывается исключение, `exception_var` (т. е. `e` в конструкции `catch (e)`) содержит значение исключения. Его можно использовать, чтобы получить больше информации об выброшенном исключении. Идентификатор доступен только в области видимости блока `catch`.

```javascript
try {
  if (!firstValidation()) {
    throw 1;
  }
  if (!secondValidation()) {
    throw 2;
  }
} catch (e) {
  // Выводит 1 или 2 (если не произошло никаких других ошибок)
  console.log(e);
}
```

## Блок `finally`

Блок `finally` содержит код который будет запущен после кода в блоках try и catch. Обратите внимание, что код в блоке `finally` запускается в независимости от того, было ли выброшено исключение или нет. Также код в блоке `finally` будет запущен вне зависимости от того, присутствует блок catch или нет. Блок `finally` можно использовать для того, чтобы скрипт безопасно завершил работу в случае ошибки. Например, если необходимо освободить память и ресурсы которые использовал скрипт.

## Возвращение значения из блока `finally`

Если блок `finally` возвращает какое-либо значение, оно становится значением, которое возвращает вся конструкция `try...catch...finally`, вне зависимости от любых инструкций return в блоках `try` и `catch`. Также игнорируются исключения, выброшенные блоком `catch`.

```javascript
(() => {
  try {
    try {
      throw new Error("oops");
    } catch (ex) {
      console.error("inner", ex.message);
      throw ex;
    } finally {
      console.log("finally");
      return; // <==
    }
  } catch (ex) {
    console.error("outer", ex.message);
  }
})();

// Logs:
// "inner" "oops"
// "finally"
```
"упс" не доходит до внешнего блока из-за инструкции `return` в блоке `finally`. То же самое произойдёт с любым значением, возвращаемым из блока `catch`.

---

## Ссылки

- try...catch
	- https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Statements/try...catch
